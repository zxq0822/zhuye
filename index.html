<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qing搜索</title>
    <link rel="icon" href="wangzhantubiao.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        neutral: '#F8FAFC',
                        dark: '#1E293B',
                        sun: '#FFD700',
                        moon: '#9CA3AF'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .search-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }

            .engine-active {
                @apply bg-primary text-white border-primary;
            }

            .dropdown-content {
                transform: scaleY(0);
                transform-origin: top;
                transition: transform 0.2s ease;
            }

            .dropdown-active .dropdown-content {
                transform: scaleY(1);
            }

            .engine-icon {
                width: 18px;
                height: 18px;
                display: inline-block;
                background-size: contain;
                background-repeat: no-repeat;
                margin-right: 6px;
            }

            .icon-baidu {
                background-image: url('faviconbaidu.ico');
            }

            .icon-bing {
                background-image: url('faviconbing.ico');
            }

            .icon-google {
                background-image: url('favicongoogle.ico');
            }

            .icon-mitata {
                background-image: url('faviconmeta.ico');
            }

            /* 黑暗模式样式 */
            .dark-mode {
                background-color: #1E293B;
                color: white;
            }

            .dark-mode .bg-white {
                background-color: #334155;
                color: white;
            }

            .dark-mode .bg-white\/80 {
                background-color: #334155;
                color: white;
            }

            .dark-mode .bg-white\/95 {
                background-color: #334155;
                color: white;
            }

            .dark-mode .text-gray-800 {
                color: white;
            }

            .dark-mode .text-gray-400 {
                color: #94a3b8;
            }

            .dark-mode .border-gray-200 {
                border-color: #475569;
            }

            .dark-mode .border-gray-100 {
                border-color: #475569;
            }

            .dark-mode .hover:bg-gray-50 {
                --tw-bg-opacity: 1;
                background-color: rgb(51 65 85 / var(--tw-bg-opacity));
            }
            
            /* 优化后的黑暗模式开关样式 */
            .theme-toggle {
                position: relative;
                display: inline-block;
                width: 64px;
                height: 32px;
            }
            
            .theme-toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .theme-toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #e2e8f0;
                transition: .4s;
                border-radius: 34px;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .theme-toggle input:checked + .theme-toggle-slider {
                background-color: #1e293b;
            }
            
            .theme-toggle-slider:before {
                position: absolute;
                content: "";
                height: 24px;
                width: 24px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            
            .theme-toggle input:checked + .theme-toggle-slider:before {
                transform: translateX(32px);
            }
            
            .theme-icon {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                font-size: 16px;
                transition: all 0.3s ease;
                z-index: 10;
            }
            
            .theme-icon-sun {
                left: 8px;
                color: #94a3b8;
            }
            
            .theme-icon-moon {
                right: 8px;
                color: #94a3b8;
            }
            
            .theme-toggle input:not(:checked) ~ .theme-icon-sun {
                color: #FFD700;
                transform: translateY(-50%) scale(1.2);
            }
            
            .theme-toggle input:checked ~ .theme-icon-moon {
                color: #ffffff;
                transform: translateY(-50%) scale(1.2);
            }
            
            /* 为太阳添加光芒效果 */
            .theme-icon-sun::after {
                content: "";
                position: absolute;
                top: 50%;
                left: 50%;
                width: 24px;
                height: 24px;
                background: rgba(255, 215, 0, 0.3);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .theme-toggle input:not(:checked) ~ .theme-icon-sun::after {
                opacity: 1;
            }
            
            /* 背景图样式 */
            .bg-image {
                background-image: url('beijingtu.png');
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
                transition: background-image 0.5s ease;
            }
            
            .bg-image-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(30, 41, 59, 0.2);
                transition: background-color 0.5s ease;
            }
            
            /* 完全透明的搜索框 - 移除磨砂玻璃效果 */
            .transparent-search {
                background-color: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .dark-mode .transparent-search {
                background-color: rgba(30, 41, 59, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            /* 搜索建议列表样式 - 移除磨砂玻璃效果 */
            .transparent-suggestions {
                background-color: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .dark-mode .transparent-suggestions {
                background-color: rgba(30, 41, 59, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            /* 鼠标悬停效果增强 */
            .suggestion-item {
                transition: all 0.2s ease;
            }
            
            .suggestion-item:hover {
                background-color: rgba(255, 255, 255, 0.15);
            }
            
            .dark-mode .suggestion-item:hover {
                background-color: rgba(255, 255, 255, 0.05);
            }
            
            /* 标题样式 */
            .search-title {
                font-size: clamp(2rem, 5vw, 3.5rem);
                font-weight: 800;
                letter-spacing: -0.05em;
                margin-bottom: 1.5rem;
                text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
            }
            
            .search-title:hover {
                transform: translateY(-2px);
            }
            
            /* 移动端适配 */
            @media (max-width: 640px) {
                .search-title {
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }
            }
            
            /* 天气组件样式 */
            .weather-widget {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 30;
                padding: 10px 15px;
                border-radius: 12px;
                backdrop-filter: blur(8px);
                transition: all 0.3s ease;
                opacity: 0.9;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            
            .weather-widget:hover {
                opacity: 1;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            }
            
            .weather-icon {
                font-size: 28px;
                min-width: 32px;
                text-align: center;
            }
            
            .weather-details {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }
            
            .weather-location {
                font-size: 14px;
                font-weight: 500;
            }
            
            .weather-temp {
                font-size: 18px;
                font-weight: 600;
            }
            
            .weather-desc {
                font-size: 12px;
                text-transform: capitalize;
            }
            
            /* 黑暗模式下的天气组件 */
            .dark-mode .weather-widget {
                background-color: rgba(30, 41, 59, 0.8);
                color: white;
            }
            
            /* 亮色模式下的天气组件 */
            .weather-widget {
                background-color: rgba(255, 255, 255, 0.8);
                color: #1E293B;
            }
            
            /* 加载动画 */
            .weather-loading {
                width: 20px;
                height: 20px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #165DFF;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
            
            /* 添加fadeIn动画 */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 0.9;
                    transform: translateY(0);
                }
            }
            
            /* 天气错误提示 */
            .weather-error {
                font-size: 14px;
                color: #ff4d4f;
                text-align: center;
            }
            
            /* 移动端适配 */
            @media (max-width: 640px) {
                .weather-widget {
                    top: 12px;
                    left: 12px;
                    padding: 8px 12px;
                }
                
                .weather-icon {
                    font-size: 24px;
                    min-width: 28px;
                }
                
                .weather-location {
                    font-size: 12px;
                }
                
                .weather-temp {
                    font-size: 16px;
                }
                
                .weather-desc {
                    font-size: 10px;
                }
            }
        }
    </style>
</head>

<body class="font-inter min-h-screen flex flex-col items-center justify-start px-4 py-8 dark-mode">
    <!-- 背景图容器 -->
    <div class="bg-image fixed inset-0 z-0"></div>
    <!-- 背景图遮罩层 -->
    <div class="bg-image-overlay z-10"></div>

    <!-- 进一步优化后的黑暗模式开关 -->
    <div class="fixed top-4 right-4 z-30">
        <label class="theme-toggle">
            <input type="checkbox" id="dark-mode-toggle" class="hidden" checked>
            <span class="theme-toggle-slider"></span>
            <i class="fa fa-sun-o theme-icon theme-icon-sun"></i>
            <i class="fa fa-moon-o theme-icon theme-icon-moon"></i>
        </label>
    </div>

    <!-- 当地天气组件 -->
    <div id="weather-widget" class="weather-widget opacity-0" style="animation: fadeIn 0.5s ease forwards 0.5s;">
        <div class="weather-icon">
            <i class="fa fa-spinner weather-loading"></i>
        </div>
        <div class="weather-details">
            <div class="weather-location">正在定位...</div>
            <div class="weather-temp">--°</div>
            <div class="weather-desc">加载中...</div>
        </div>
    </div>

    <!-- 搜索区域 -->
    <div class="w-full max-w-4xl z-20 mt-24 md:mt-32">
        <!-- 搜索标题 -->
        <h1 class="search-title text-center">
            <span class="text-white">Qing</span>
            <span class="text-primary">搜索</span>
        </h1>
        
        <!-- 搜索框 -->
        <div class="relative group">
            <form id="search-form" class="w-full">
                <div
                    class="flex items-center rounded-full transparent-search p-1 search-shadow transition-all duration-300 group-hover:border-primary/50 group-focus-within:border-primary/70">
                    <!-- 搜索引擎下拉菜单 -->
                    <div id="engine-dropdown" class="dropdown relative mr-2">
                        <button id="current-engine"
                            class="engine-btn flex items-center px-3 py-1.5 text-sm font-medium transition-all duration-200 whitespace-nowrap focus:outline-none rounded-full bg-white/10 hover:bg-white/20 dark:hover:bg-white/5">
                            <span class="engine-icon icon-baidu"></span>
                            <i class="fa fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div id="engine-options"
                            class="dropdown-content absolute top-full left-0 mt-1 transparent-suggestions rounded-xl shadow-lg overflow-hidden w-28 z-20">
                            <button data-engine="baidu"
                                class="engine-option w-full text-left px-3 py-2 suggestion-item flex items-center">
                                <span class="engine-icon icon-baidu"></span> 百度
                            </button>
                            <button data-engine="bing"
                                class="engine-option w-full text-left px-3 py-2 suggestion-item flex items-center">
                                <span class="engine-icon icon-bing"></span> 必应
                            </button>
                            <button data-engine="google"
                                class="engine-option w-full text-left px-3 py-2 suggestion-item flex items-center">
                                <span class="engine-icon icon-google"></span> 谷歌
                            </button>
                            <button data-engine="mitata"
                                class="engine-option w-full text-left px-3 py-2 suggestion-item flex items-center">
                                <span class="engine-icon icon-mitata"></span> 秘塔
                            </button>
                        </div>
                    </div>

                    <!-- 分隔线 -->
                    <div class="h-6 w-px bg-white/20 dark:bg-white/10"></div>

                    <div class="flex items-center px-3">
                        <i id="search-icon" class="fa fa-search text-gray-400 text-lg"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="你想搜啥..."
                        class="flex-1 w-full py-2 px-2 text-gray-800 dark:text-white bg-transparent outline-none text-lg"
                        autocomplete="off">
                    <button type="submit"
                        class="bg-primary/90 text-white px-5 py-1.5 rounded-full font-medium transition-all duration-200 hover:bg-primary focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa fa-search text-lg"></i>
                    </button>
                </div>
            </form>

            <!-- 搜索建议 -->
            <div id="suggestions"
                class="hidden absolute top-full left-0 right-0 mt-2 transparent-suggestions rounded-xl shadow-lg overflow-hidden z-10">
                <ul id="suggestions-list" class="divide-y divide-white/10 dark:divide-white/5"></ul>
            </div>
        </div>
    </div>

    <script>
        // 搜索引擎配置
        const searchEngines = {
            'baidu': {
                url: 'https://www.baidu.com/s',
                param: 'wd',
                iconClass: 'icon-baidu',
                color: '#2319DC',
                name: '百度'
            },
            'bing': {
                url: 'https://cn.bing.com/search', // 使用中国版必应
                param: 'q',
                iconClass: 'icon-bing',
                color: '#008373',
                name: '必应'
            },
            'google': {
                url: 'https://www.google.com/search',
                param: 'q',
                iconClass: 'icon-google',
                color: '#4285F4',
                name: '谷歌'
            },
            'mitata': {
                url: 'https://www.mitata.com/search',
                param: 'q',
                iconClass: 'icon-mitata',
                color: '#165DFF',
                name: '秘塔'
            }
        };

        // 当前选中的搜索引擎
        let currentEngine = 'baidu';

        // DOM元素
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchIcon = document.getElementById('search-icon');
        const suggestions = document.getElementById('suggestions');
        const suggestionsList = document.getElementById('suggestions-list');
        const engineDropdown = document.getElementById('engine-dropdown');
        const currentEngineBtn = document.getElementById('current-engine');
        const engineOptions = document.getElementById('engine-options');
        const engineOptionBtns = document.querySelectorAll('.engine-option');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const body = document.body;
        const weatherWidget = document.getElementById('weather-widget');
        const weatherIcon = weatherWidget.querySelector('.weather-icon');
        const weatherLocation = weatherWidget.querySelector('.weather-location');
        const weatherTemp = weatherWidget.querySelector('.weather-temp');
        const weatherDesc = weatherWidget.querySelector('.weather-desc');

        // 初始化搜索引擎下拉菜单
        engineOptionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const engine = btn.getAttribute('data-engine');
                setCurrentEngine(engine);
                engineDropdown.classList.remove('dropdown-active');
            });
        });

        // 点击下拉菜单按钮切换显示状态
        currentEngineBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            engineDropdown.classList.toggle('dropdown-active');
        });

        // 点击其他区域关闭下拉菜单
        document.addEventListener('click', () => {
            engineDropdown.classList.remove('dropdown-active');
        });

        // 设置当前搜索引擎
        function setCurrentEngine(engine) {
            currentEngine = engine;
            const engineData = searchEngines[engine];

            // 更新下拉菜单按钮 - 只显示图标
            currentEngineBtn.innerHTML = `
                <span class="engine-icon ${engineData.iconClass}"></span>
                <i class="fa fa-chevron-down ml-1 text-xs"></i>
            `;

            // 更新搜索图标
            updateSearchIcon();
        }

        // 更新搜索图标颜色
        function updateSearchIcon() {
            const engine = searchEngines[currentEngine];
            searchIcon.className = `fa ${engine.icon || 'fa-search'} text-gray-400 text-lg`;
        }

        // 处理搜索表单提交
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                const engine = searchEngines[currentEngine];
                // 为必应添加语言参数，确保使用中文界面
                let searchUrl = engine.url;
                if (engine === searchEngines.bing) {
                    searchUrl += '?setmkt=zh-CN&setlang=zh-CN';
                    searchUrl += `&${engine.param}=${encodeURIComponent(query)}`;
                } else {
                    searchUrl += `?${engine.param}=${encodeURIComponent(query)}`;
                }
                window.location.href = searchUrl;
            }
        });

        // 搜索建议功能
        searchInput.addEventListener('input', debounce(async function () {
            const query = this.value.trim();
            if (!query) {
                suggestions.classList.add('hidden');
                return;
            }

            try {
                // 根据当前搜索引擎获取建议
                let suggestionsData = [];
                if (currentEngine === 'baidu') {
                    const response = await fetch(`https://suggestion.baidu.com/su?wd=${encodeURIComponent(query)}&cb=JSON_CALLBACK`, {
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Referer': 'https://www.baidu.com'
                        }
                    });
                    const text = await response.text();
                    // 解析JSONP格式
                    const jsonpRegex = /JSON_CALLBACK\((.*)\)/;
                    const matches = text.match(jsonpRegex);
                    if (matches && matches[1]) {
                        const data = JSON.parse(matches[1]);
                        suggestionsData = data.s || [];
                    }
                } else if (currentEngine === 'bing') {
                    const response = await fetch(`https://api.bing.com/osjson.aspx?query=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    suggestionsData = data[1] || [];
                } else if (currentEngine === 'google') {
                    const response = await fetch(`https://www.google.com/complete/search?client=chrome&q=${encodeURIComponent(query)}`);
                    const text = await response.text();
                    try {
                        const data = JSON.parse(text);
                        suggestionsData = data[1] || [];
                    } catch (e) {
                        console.error('Failed to parse Google suggestions', e);
                    }
                }

                // 显示建议
                displaySuggestions(suggestionsData);
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                suggestions.classList.add('hidden');
            }
        }, 300));

        // 点击其他区域关闭建议
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
        });

        // 显示搜索建议
        function displaySuggestions(suggestionsData) {
            if (!suggestionsData.length) {
                suggestions.classList.add('hidden');
                return;
            }

            suggestionsList.innerHTML = '';
            suggestionsData.forEach(suggestion => {
                const li = document.createElement('li');
                li.className = 'px-4 py-3 suggestion-item cursor-pointer';
                li.textContent = suggestion;
                li.addEventListener('click', () => {
                    searchInput.value = suggestion;
                    suggestions.classList.add('hidden');
                    searchForm.dispatchEvent(new Event('submit'));
                });
                suggestionsList.appendChild(li);
            });

            suggestions.classList.remove('hidden');
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 初始化
        updateSearchIcon();

        // 检查用户偏好的颜色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            darkModeToggle.checked = true;
            body.classList.add('dark-mode');
        }

        // 黑暗模式切换逻辑
        darkModeToggle.addEventListener('change', function () {
            if (this.checked) {
                body.classList.add('dark-mode');
                document.querySelector('.bg-image-overlay').style.backgroundColor = 'rgba(30, 41, 59, 0.2)';
            } else {
                body.classList.remove('dark-mode');
                document.querySelector('.bg-image-overlay').style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            }
        });

        // 天气相关功能
        async function fetchWeatherData(lat, lon) {
            try {
                // 使用和风天气 API 获取天气数据
                const apiKey = '08f92e23eaef4971b68261708607b897'; // 请替换为你的和风天气API密钥
                const locationKey = await fetchLocationKey(lat, lon, apiKey);
                
                if (!locationKey) {
                    throw new Error('无法获取位置ID');
                }
                
                // 获取实时天气
                const weatherResponse = await fetch(
                    `https://devapi.qweather.com/v7/weather/now?location=${locationKey}&key=${apiKey}`
                );
                
                // 获取城市信息
                const cityResponse = await fetch(
                    `https://geoapi.qweather.com/v2/city/lookup?location=${locationKey}&key=${apiKey}`
                );
                
                if (!weatherResponse.ok || !cityResponse.ok) {
                    throw new Error('无法获取天气数据');
                }
                
                const weatherData = await weatherResponse.json();
                const cityData = await cityResponse.json();
                
                return {
                    weather: weatherData,
                    city: cityData
                };
            } catch (error) {
                console.error('获取天气数据失败:', error);
                return null;
            }
        }
        
        // 获取位置ID
        async function fetchLocationKey(lat, lon, apiKey) {
            try {
                const response = await fetch(
                    `https://geoapi.qweather.com/v2/city/lookup?location=${lon},${lat}&key=${apiKey}`
                );
                
                if (!response.ok) {
                    throw new Error('无法获取位置ID');
                }
                
                const data = await response.json();
                if (data.code === '200' && data.location && data.location.length > 0) {
                    return data.location[0].id;
                }
                
                return null;
            } catch (error) {
                console.error('获取位置ID失败:', error);
                return null;
            }
        }

        // 根据和风天气代码获取对应的图标
        function getWeatherIcon(weatherCode) {
            // 和风天气代码到Font Awesome图标的映射
            const iconMap = {
                // 晴
                '100': 'fa-sun-o',
                // 多云
                '101': 'fa-cloud-sun-o',
                '102': 'fa-cloud-sun-o',
                '103': 'fa-cloud',
                '104': 'fa-cloud',
                // 雨
                '300': 'fa-cloud-rain',
                '301': 'fa-cloud-rain',
                '302': 'fa-tint',
                '303': 'fa-tint',
                '304': 'fa-tint',
                '305': 'fa-cloud-rain',
                '306': 'fa-cloud-rain',
                '307': 'fa-cloud-rain',
                '308': 'fa-cloud-rain',
                '309': 'fa-cloud-rain',
                '310': 'fa-cloud-rain',
                '311': 'fa-cloud-rain',
                '312': 'fa-cloud-rain',
                '313': 'fa-cloud-rain',
                '314': 'fa-cloud-rain',
                '315': 'fa-cloud-rain',
                '316': 'fa-cloud-rain',
                '317': 'fa-cloud-rain',
                '318': 'fa-cloud-rain',
                '399': 'fa-cloud-rain',
                // 雪
                '400': 'fa-snowflake-o',
                '401': 'fa-snowflake-o',
                '402': 'fa-snowflake-o',
                '403': 'fa-snowflake-o',
                '404': 'fa-snowflake-o',
                '405': 'fa-snowflake-o',
                '406': 'fa-snowflake-o',
                '407': 'fa-snowflake-o',
                '499': 'fa-snowflake-o',
                // 雾
                '500': 'fa-smog',
                '501': 'fa-smog',
                '502': 'fa-smog',
                '503': 'fa-smog',
                '504': 'fa-smog',
                '507': 'fa-smog',
                '508': 'fa-smog',
                '509': 'fa-smog',
                '510': 'fa-smog',
                '511': 'fa-smog',
                '512': 'fa-smog',
                '513': 'fa-smog',
                '514': 'fa-smog',
                '515': 'fa-smog',
                '599': 'fa-smog',
                // 雷暴
                '310': 'fa-bolt',
                '311': 'fa-bolt',
                '312': 'fa-bolt',
                '313': 'fa-bolt',
                // 默认图标
                default: 'fa-question-circle-o'
            };
            
            return iconMap[weatherCode] || iconMap.default;
        }

        // 更新天气显示
        function updateWeatherDisplay(weatherData) {
            if (!weatherData) {
                weatherIcon.innerHTML = '<i class="fa fa-exclamation-triangle weather-error"></i>';
                weatherLocation.textContent = '定位失败';
                weatherTemp.textContent = '--°';
                weatherDesc.textContent = '无法获取天气';
                return;
            }
            
            const { weather, city } = weatherData;
            
            if (weather.code !== '200' || !weather.now || !city.location || city.location.length === 0) {
                weatherIcon.innerHTML = '<i class="fa fa-exclamation-triangle weather-error"></i>';
                weatherLocation.textContent = '定位失败';
                weatherTemp.textContent = '--°';
                weatherDesc.textContent = '无法获取天气';
                return;
            }
            
            const { now } = weather;
            const location = city.location[0];
            const temp = Math.round(parseFloat(now.temp));
            const weatherCode = now.icon;
            const weatherIconClass = getWeatherIcon(weatherCode);
            const weatherText = now.text;
            
            // 更新天气信息
            weatherIcon.innerHTML = `<i class="fa ${weatherIconClass}"></i>`;
            weatherLocation.textContent = location.name;
            weatherTemp.textContent = `${temp}°`;
            weatherDesc.textContent = weatherText;
            
            // 添加颜色效果
            if (temp > 28) {
                weatherTemp.classList.add('text-red-500');
            } else if (temp < 10) {
                weatherTemp.classList.add('text-blue-400');
            } else {
                weatherTemp.classList.remove('text-red-500', 'text-blue-400');
            }
        }

        // 获取位置信息 - 添加位置权限请求提示
        function getLocation() {
            // 检查是否有位置权限
            if ('permissions' in navigator) {
                navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
                    if (result.state === 'granted') {
                        // 已有权限，直接获取位置
                        getCurrentPosition();
                    } else if (result.state === 'prompt') {
                        // 提示用户授权
                        weatherLocation.textContent = '请允许位置访问';
                        getCurrentPosition();
                    } else if (result.state === 'denied') {
                        // 已拒绝，使用默认位置
                        weatherLocation.textContent = '位置访问被拒绝';
                        fetchDefaultWeather();
                    }
                    
                    // 监听权限状态变化
                    result.onchange = function() {
                        if (this.state === 'granted') {
                            getCurrentPosition();
                        }
                    };
                });
            } else {
                // 浏览器不支持权限查询，直接请求位置
                getCurrentPosition();
            }
        }
        
        // 实际获取位置的函数
        function getCurrentPosition() {
            if (navigator.geolocation) {
                // 设置位置超时时间和最大缓存时间
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        weatherLocation.textContent = '正在获取天气...';
                        const weatherData = await fetchWeatherData(latitude, longitude);
                        updateWeatherDisplay(weatherData);
                    },
                    (error) => {
                        console.error('获取位置失败:', error);
                        // 显示错误信息
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                weatherLocation.textContent = '位置访问被拒绝';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                weatherLocation.textContent = '位置信息不可用';
                                break;
                            case error.TIMEOUT:
                                weatherLocation.textContent = '获取位置超时';
                                break;
                            default:
                                weatherLocation.textContent = '未知位置错误';
                        }
                        // 使用默认位置
                        fetchDefaultWeather();
                    },
                    {
                        timeout: 15000,  // 15秒超时
                        maximumAge: 300000,  // 5分钟缓存
                        enableHighAccuracy: false  // 不使用高精度，节省电量
                    }
                );
            } else {
                console.error('浏览器不支持地理位置');
                weatherLocation.textContent = '浏览器不支持位置服务';
                // 浏览器不支持地理位置，使用默认位置
                fetchDefaultWeather();
            }
        }

        // 获取默认位置（北京）的天气
        async function fetchDefaultWeather() {
            // 北京的经纬度
            const lat = 39.9042;
            const lon = 116.4074;
            weatherLocation.textContent = '使用默认位置（北京）';
            const weatherData = await fetchWeatherData(lat, lon);
            updateWeatherDisplay(weatherData);
        }

        // 初始化天气组件
        function initWeatherWidget() {
            // 初始加载动画
            weatherIcon.innerHTML = '<i class="fa fa-spinner weather-loading"></i>';
            weatherLocation.textContent = '正在定位...';
            weatherTemp.textContent = '--°';
            weatherDesc.textContent = '加载中...';
            
            // 获取天气数据
            getLocation();
            
            // 每小时刷新一次天气数据
            setInterval(getLocation, 3600000);
        }

        // 点击天气组件刷新
        weatherWidget.addEventListener('click', () => {
            weatherIcon.innerHTML = '<i class="fa fa-spinner weather-loading"></i>';
            weatherDesc.textContent = '刷新中...';
            getLocation();
        });

        // 页面加载完成后初始化天气组件
        window.addEventListener('load', initWeatherWidget);
    </script>
</body>

</html>
